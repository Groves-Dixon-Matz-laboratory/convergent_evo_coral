#GO_MWU_viewResults.R
#Use this script to access the GO enrichment results generated by GO_MWU.R
#This is kept separate to avoid re-running the analysis.

# Edit these to match your data file names: 
setwd("~/gitreps/convergent_evo_coral/overlap_results/strict/GO_MWU")

#select input file
#vertical
input='GOMWU_input1_branchSitesVertical.csv'
input='GOMWU_input2_covergenceVV.csv'
input='GOMWU_input3_bs_convergence_overlapVV.csv'
input='GOMWU_input4_flagged_convergence_overlapVV.csv'

#horizontal
input='GOMWU_input1_branchSitesHorizontal.csv'
input='GOMWU_input2_covergenceHH.csv'
input='GOMWU_input3_bs_convergence_overlapHH.csv'
input='GOMWU_input4_flagged_convergence_overlapHH.csv'



goAnnotations="singleCopyAnnotations_GO_gomwu.tsv" # two-column, tab-delimited, one line per gene, multiple GO terms separated by semicolon. If you have multiple lines per gene, use nrify_GOtable.pl prior to running this script.
goDatabase="go.obo" # download from http://www.geneontology.org/GO.downloads.ontology.shtml
goDivision="BP"     # either MF, or BP, or CC
source("gomwu.functions.R")


# Plotting results
quartz()
gomwuPlot(input,goAnnotations,goDivision,
	absValue=0.99,  # genes with the measure value exceeding this will be counted as "good genes". Specify absValue=0.001 if you are doing Fisher's exact test for standard GO enrichment or analyzing a WGCNA module (all non-zero genes = "good genes").
	level1=0.1, # FDR threshold for plotting. Specify level1=1 to plot all GO categories containing genes exceeding the absValue.
	level2=0.05, # FDR cutoff to print in regular (not italic) font.
	level3=0.01, # FDR cutoff to print in large bold font.
	txtsize=1.2,    # decrease to fit more on one page, or increase (after rescaling the plot so the tree fits the text) for better "word cloud" effect
	treeHeight=0.5, # height of the hierarchical clustering tree
#	colors=c("dodgerblue2","firebrick1","skyblue","lightcoral") # these are default colors, un-remar and change if needed
)
# manually rescale the plot so the tree matches the text 
# if there are too many categories displayed, try make it more stringent with level1=0.05,level2=0.01,level3=0.001.  


#LOOK AT RESULTS TABLE
resName = paste(paste('MWU', goDivision, sep = "_"), input, sep = "_")
res=read.table(resName, header = T)
res=res[order(res$pval),]
head(res, n=20)

#OUTPUT TOP 20 REGARDLESS OF FDR
tabOut = paste('..', sub(".csv", "_top20.tsv", resName), sep="/")
tabOut
write.table(head(res, n=20), file=tabOut, quote=F, sep="\t")

#VIEW DENSITY OF THE NUMBER OF SEQUENCES
plot(density(res$nseqs))

#PULL OUT THE SIGNIFICANT GO TERMS
#also unmerge GO names
sigGos = res[res$p.adj<0.1, c('term', 'name')]
sigGos$name = as.character(sigGos$name)



#LOOK AT INDIVIDUAL GENES FROM GO TERMS
gFile = paste(goDivision, input, sep="_")
gdat = read.table(gFile, header = T, stringsAsFactors=F)
goGenes = gdat[gdat$term %in% sigGos$term & gdat$value >= ABS.VALUE,]
goGenes

#merge with gene names
adat = read.table("~/gitreps/convergent_evo_coral/ortholog_tables/singleCopyAnnotationsWithDescriptions.tsv", header = T, sep="\t", quote="")
colnames(adat)[1] = 'seq'
m=merge(goGenes, adat, by = 'seq', all.x=T)
m=m[order(m$name.x),]

#make table without duplicated descriptions
nonDup = m[!duplicated(m$seq),]
nonDup = nonDup[order(nonDup$name.x),]
outName = paste(paste('../interesting_genes/significantGOgenes', goDivision, sep="_"), input,  sep="_")
outName=sub(".csv", ".tsv", outName)
print(outName)
write.table(m, file=outName, quote=F, row.names=F, sep="\t")

#PARITCULAR GO OF INTEREST
gotags = c('GO:0016023')
select = goGenes[goGenes$term %in% gotags,]
mselect = merge(select, adat, by = 'seq')
mselect


#LOO




